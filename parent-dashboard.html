<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RSPS • Parent Dashboard</title>
  <style>
    :root{ --brand:#0b6ef3; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --bg:#f8fafc; --card:#fff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    main.container{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:14px}
    h3{margin:0 0 8px}
    table{width:100%;border-collapse:collapse}
    th,td{border-top:1px solid var(--line);padding:8px;text-align:left;font-size:14px;vertical-align:top}
    .grid{display:grid;gap:10px}
    .muted{color:var(--muted);font-size:13px}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const sb = supabase.createClient(
      "https://eqbbddsjutlupckqzlpq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxYmJkZHNqdXRsdXBja3F6bHBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDkzOTMsImV4cCI6MjA3MDIyNTM5M30.CVmsiBCCp98ZQQOEe-1QgrvcJGeRP4DGHUx6j0wPCRI"
    );
    async function ensureParent(){
      const { data:{user} } = await sb.auth.getUser();
      if(!user){ location.href='index.html#login'; return null; }
      const { data:p } = await sb.from('profiles').select('role,full_name,email').eq('user_id',user.id).single();
      if(!p || p.role!=='parent'){ alert('Access denied for parent'); location.href='index.html#login'; return null; }
      const who = document.getElementById('who'); if(who) who.textContent=(p.full_name?p.full_name+' (parent)':(p.email+' (parent)'));
      return user;
    }
    const el = id=>document.getElementById(id);
  </script>
</head>
<body>
<header>Parent Dashboard <span class="muted" id="who"></span> <a class="btn" style="background:#fff;color:#0b6ef3;border:1px solid #0b6ef3;border-radius:10px;padding:8px 12px" href="index.html#login">Logout</a></header>

<main class="container">
  <div class="card">
    <h3>My Child’s Details</h3>
    <table><tbody id="p_child"><tr><td>Loading…</td></tr></tbody></table>
  </div>

  <div class="card">
    <h3>Updates — Syllabus • Exams • Date Sheet • Daily Progress</h3>
    <div id="p_updates" class="grid"></div>
  </div>

  <div class="card">
    <h3>Academic Calendar & Holidays</h3>
    <div id="acad" class="grid" style="grid-template-columns:1fr 1fr"></div>
  </div>
</main>

<script>
let USER=null, CHILD=null;

function card(html){ const c=document.createElement('div'); c.className='card'; c.innerHTML=html; return c; }

async function loadChild(){
  const { data: rows } = await sb.from('students')
    .select('id, admission_no, class_section, student_name, admitted_class_id, father_name, mother_name, whatsapp_no, father_contact_no, aadhar_no, session')
    .eq('guardian_user_id', USER.id).limit(1);
  CHILD = rows?.[0] || null;

  const tb = el('p_child'); tb.innerHTML='';
  if(!CHILD){
    tb.innerHTML = '<tr><td>No student linked to this account yet. Please contact office to link your email in the student record.</td></tr>';
    return;
  }
  tb.innerHTML = `
    <tr><th>Admission No.</th><td>${CHILD.admission_no||''}</td></tr>
    <tr><th>Name</th><td>${CHILD.student_name||''}</td></tr>
    <tr><th>Class</th><td>${CHILD.admitted_class_id||''} (${CHILD.class_section||''})</td></tr>
    <tr><th>Session</th><td>${CHILD.session||''}</td></tr>
    <tr><th>Father</th><td>${CHILD.father_name||''} — ${CHILD.father_contact_no||''}</td></tr>
    <tr><th>Mother</th><td>${CHILD.mother_name||''}</td></tr>
    <tr><th>WhatsApp</th><td>${CHILD.whatsapp_no||''}</td></tr>
    <tr><th>Aadhaar</th><td>${CHILD.aadhar_no||''}</td></tr>`;
}

async function loadUpdates(){
  const up = el('p_updates'); up.innerHTML='';
  const cls = CHILD?.admitted_class_id || '';
  // Pull latest entries for the child's class (if class filter not present, we still show latest 3 site-wide)
  const [sy, ex, ds, pr] = await Promise.all([
    sb.from('syllabus_units').select('id, content, class_id, created_at').or(`class_id.eq.${cls},class_id.is.null`).order('created_at',{ascending:false}).limit(3),
    sb.from('exam_schedule').select('id, title, exam_date, class_id, created_at').or(`class_id.eq.${cls},class_id.is.null`).order('created_at',{ascending:false}).limit(3),
    sb.from('date_sheets').select('id, title, link, class_id, created_at').or(`class_id.eq.${cls},class_id.is.null`).order('created_at',{ascending:false}).limit(3),
    sb.from('progress_reports').select('id, image_path, created_at').order('created_at',{ascending:false}).limit(6)
  ]);
  (sy.data||[]).forEach(s=> up.appendChild(card(`<h4>Syllabus</h4><p class="muted">${new Date(s.created_at).toLocaleString()}</p><div>${(s.content||'').slice(0,400)}</div>`)));
  (ex.data||[]).forEach(e=> up.appendChild(card(`<h4>Exam</h4><p class="muted">${new Date(e.created_at).toLocaleString()}</p><div><strong>${e.title||''}</strong> — ${e.exam_date||''}</div>`)));
  (ds.data||[]).forEach(d=> up.appendChild(card(`<h4>Date Sheet</h4><p class="muted">${new Date(d.created_at).toLocaleString()}</p><div><strong>${d.title||'Date Sheet'}</strong><br><a href="${d.link||'#'}" target="_blank" rel="noopener">Open</a></div>`)));
  (pr.data||[]).forEach(p=>{
    const url = p.image_path ? sb.storage.from('progress').getPublicUrl(p.image_path).data.publicUrl : '';
    up.appendChild(card(`<h4>Daily Progress</h4><p class="muted">${new Date(p.created_at).toLocaleString()}</p>${url?`<img src="${url}" alt="progress image" style="max-width:100%;border-radius:10px;border:1px solid #e5e7eb"/>`:''}`));
  });
  if(!up.children.length){ up.appendChild(card('<p class="muted">No updates yet.</p>')); }
}

async function loadAcademic(){
  const wrap = el('acad'); wrap.innerHTML='';
  const ac = await sb.from('academic_calendar').select('date, title').order('date');
  const ho = await sb.from('holidays').select('date, title').order('date');
  const mk=(t,rows)=>{ const c=document.createElement('div'); c.className='card'; c.innerHTML=`<h4>${t}</h4>`+(rows||[]).map(r=>`<div>${r.date} — ${r.title}</div>`).join('') || '<p class="muted">No entries.</p>'; return c; };
  wrap.appendChild(mk('Academic Calendar', ac.data));
  wrap.appendChild(mk('Holidays', ho.data));
}

document.addEventListener('DOMContentLoaded', async ()=>{
  USER = await ensureParent(); if(!USER) return;
  await loadChild();
  await loadUpdates();
  await loadAcademic();
});
</script>
</body>
</html>
