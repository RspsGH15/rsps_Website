<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RSPS • Accounts Dashboard</title>
  <!-- RSPS BUILD v6 -->
  <style>
    :root{ --brand:#0b6ef3; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --bg:#f8fafc; --card:#fff; --ok:#16a34a; --err:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    main.container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:14px}
    h2{margin:0 0 10px} h3{margin:0 0 8px} h4{margin:0 0 6px}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-outline{background:#fff;color:var(--brand);border:1px solid var(--brand);border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{border-top:1px solid var(--line);padding:8px;text-align:left;font-size:14px;vertical-align:top}
    input,select,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-size:14px}
    .grid{display:grid;gap:10px}
    .form-rows{display:grid;grid-template-columns:1fr 2fr;gap:10px;align-items:center}
    @media (max-width:760px){.form-rows{grid-template-columns:1fr}}
    .form-rows label{font-weight:600;font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .hidden{display:none!important}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const sb = supabase.createClient(
      "https://eqbbddsjutlupckqzlpq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxYmJkZHNqdXRsdXBja3F6bHBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDkzOTMsImV4cCI6MjA3MDIyNTM5M30.CVmsiBCCp98ZQQOEe-1QgrvcJGeRP4DGHUx6j0wPCRI"
    );
    async function ensureRole(role){
      const { data:{user} } = await sb.auth.getUser();
      if(!user){ location.href='index.html#login'; return; }
      const { data:p } = await sb.from('profiles').select('role,full_name,email').eq('user_id',user.id).single();
      if(!p || p.role!==role){ alert('Access denied for '+role); location.href='index.html#login'; return; }
      const who = document.getElementById('who'); if(who) who.textContent=(p.full_name?p.full_name+' ('+p.role+')':(p.email+' ('+p.role+')'));
    }
    const el = (id)=>document.getElementById(id);
    const isTen = (s)=>/^\d{10}$/.test(s||'');
    const isAadhaar = (s)=>/^\d{12}$/.test(s||'');
    const hasNoDigits = (s)=>!/\d/.test(s||'');
  </script>
</head>
<body>
<header>Accounts Dashboard <span class="muted" id="who"></span> <a class="btn-outline" href="index.html#login">Logout</a></header>

<main class="container">
  <div class="card">
    <h3>Students — Add / Edit</h3>
    <p class="muted">Required fields are marked with *.</p>

    <div class="form-rows">
      <label>Admission Number*</label><input id="st_admission_no" placeholder="RSPS/2026/0012"/>
      <label>Class Section*</label><input id="st_class_section" placeholder="A"/>
      <label>Student Name*</label><input id="st_full_name" inputmode="text"/>
      <label>Session*</label><input id="st_session" placeholder="2026-27"/>
      <label>Father Name*</label><input id="st_father_name" inputmode="text"/>
      <label>Mother Name*</label><input id="st_mother_name" inputmode="text"/>
      <label>Date of Birth*</label><input id="st_dob" type="date"/>
      <label>Date of Admission*</label><input id="st_admission_date" type="date"/>
      <label>Gender*</label>
      <select id="st_gender"><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select>
      <label>Aadhaar (12 digits)*</label><input id="st_aadhar" placeholder="############" inputmode="numeric"/>
      <label>Class*</label>
      <select id="st_class">
        <option value="">Select class</option>
        <option>Nursery</option><option>LKG</option><option>UKG</option>
        <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option><option>Class 5</option>
        <option>Class 6</option><option>Class 7</option><option>Class 8</option><option>Class 9</option><option>Class 10</option>
      </select>
      <label>Religion*</label><input id="st_religion"/>
      <label>Social Category*</label><input id="st_social" placeholder="GEN / SC / ST / OBC / EWS"/>
      <label>WhatsApp No.*</label><input id="st_whatsapp" placeholder="10-digit mobile" inputmode="numeric"/>
      <label>Father Contact No.*</label><input id="st_father_phone" placeholder="10-digit mobile" inputmode="numeric"/>
      <label>Address*</label><input id="st_address" placeholder="House, Village/Locality, Post, Tehsil, District"/>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Transport</h4>
      <div class="form-rows">
        <label>Transport Availed*</label>
        <select id="st_transport_select">
          <option value="false">NO</option>
          <option value="true">YES</option>
        </select>
        <input id="st_transport" type="hidden" value="false"/>
        <div id="tr_details" class="hidden" style="grid-column:1/-1">
          <div class="form-rows">
            <label>Pickup Bus No.</label><input id="st_pickup_bus"/>
            <label>Drop-off Bus No.</label><input id="st_drop_bus"/>
            <label>Is Bus No. same for pickup & drop-off?</label><input type="checkbox" id="st_same_bus"/>
            <label>Pickup Stoppage</label><input id="st_pickup_stop"/>
            <label>Drop-off Stoppage</label><input id="st_drop_stop"/>
            <label>Is Stoppage same for pickup & drop-off?</label><input type="checkbox" id="st_same_stop"/>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Other Contacts</h4>
      <div class="form-rows">
        <label>Mother Contact No.</label><input id="st_mother_phone" inputmode="numeric"/>
        <label>Neighbour Phone</label><input id="st_neigh_phone" inputmode="numeric"/>
        <label>Relation (Neighbour)</label><input id="st_neigh_rel"/>
        <label>Blood Group</label><input id="st_bgroup" placeholder="B+, O-, AB+"/>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Siblings</h4>
      <div class="form-rows">
        <label>Sibling in school?</label>
        <select id="st_sibling_select">
          <option value="false">NO</option>
          <option value="true">YES</option>
        </select>
        <input id="st_has_sibling" type="hidden" value="false"/>
        <div id="sib_details" class="hidden" style="grid-column:1/-1">
          <div class="form-rows">
            <label>Sibling name(s) & class(es)</label>
            <input id="st_siblings" placeholder="Asha (III-A); Mohit (VI-B)"/>
          </div>
        </div>
      </div>
    </div>

    <div class="form-rows" style="margin-top:10px">
      <label>(Optional) Parent Email (link to portal)</label><input id="st_guardian_email" placeholder="parent@example.com"/>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="st_save">Save / Add</button>
      <button class="btn-outline" id="st_clear">Clear</button>
      <span id="st_msg" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <h3>All Students</h3>
    <input id="st_search" placeholder="Search by name / Aadhaar / phone / admission no." style="margin-bottom:8px;width:100%"/>
    <table>
      <thead><tr><th>Adm No.</th><th>Name</th><th>Class</th><th>Father</th><th>Phones</th><th>Aadhaar</th><th>Actions</th></tr></thead>
      <tbody id="st_rows"></tbody>
    </table>
  </div>
</main>

<script>
  // Transport / Sibling toggles (dropdown-based)
  function syncTransportUI(){
    const yes = el('st_transport_select').value === 'true';
    el('st_transport').value = yes ? 'true' : 'false';
    el('tr_details').classList.toggle('hidden', !yes);
  }
  function syncSameBus(){
    const same = el('st_same_bus').checked;
    const pu = el('st_pickup_bus'), dr = el('st_drop_bus');
    if(same){ dr.value=pu.value; dr.setAttribute('disabled','disabled'); } else { dr.removeAttribute('disabled'); }
  }
  function syncSameStop(){
    const same = el('st_same_stop').checked;
    const pu = el('st_pickup_stop'), dr = el('st_drop_stop');
    if(same){ dr.value=pu.value; dr.setAttribute('disabled','disabled'); } else { dr.removeAttribute('disabled'); }
  }
  function syncSiblingUI(){
    const yes = el('st_sibling_select').value === 'true';
    el('st_has_sibling').value = yes ? 'true' : 'false';
    document.getElementById('sib_details').classList.toggle('hidden', !yes);
  }

  function readForm(){
    return {
      admission_no: el('st_admission_no').value.trim(),
      class_section: el('st_class_section').value.trim(),
      student_name: el('st_full_name').value.trim(),
      session: el('st_session').value.trim(),
      father_name: el('st_father_name').value.trim(),
      mother_name: el('st_mother_name').value.trim(),
      dob: el('st_dob').value,
      admission_date: el('st_admission_date').value,
      address: el('st_address').value.trim(),
      gender: el('st_gender').value,
      aadhar_no: el('st_aadhar').value.trim(),
      admitted_class_id: el('st_class').value,
      religion: el('st_religion').value.trim(),
      social_category: el('st_social').value.trim(),
      whatsapp_no: el('st_whatsapp').value.trim(),
      father_contact_no: el('st_father_phone').value.trim(),
      transport_availed: el('st_transport').value==='true',
      pickup_bus_no: el('st_pickup_bus').value.trim(),
      drop_bus_no: el('st_drop_bus').value.trim(),
      pickup_stoppage: el('st_pickup_stop').value.trim(),
      drop_stoppage: el('st_drop_stop').value.trim(),
      mother_contact_no: el('st_mother_phone').value.trim(),
      neighbour_contact_no: el('st_neigh_phone').value.trim(),
      neighbour_relation: el('st_neigh_rel').value.trim(),
      blood_group: el('st_bgroup').value.trim(),
      has_sibling: el('st_has_sibling').value==='true',
      sibling_names: el('st_siblings').value.trim() ? el('st_siblings').value.trim().split(';').map(s=>s.trim()) : null,
      guardian_email: el('st_guardian_email').value.trim()
    };
  }

  function validate(v){
    const m = el('st_msg'); m.classList.remove('ok','err'); m.textContent='';
    if(!v.admission_no) return m.textContent='Admission Number is required.', m.classList.add('err'), false;
    if(!v.class_section) return m.textContent='Class Section is required.', m.classList.add('err'), false;
    if(!v.student_name || !hasNoDigits(v.student_name)) return m.textContent='Student name is required (no numbers).', m.classList.add('err'), false;
    if(!v.session) return m.textContent='Session is required.', m.classList.add('err'), false;
    if(!v.father_name || !hasNoDigits(v.father_name)) return m.textContent='Father name invalid (no numbers).', m.classList.add('err'), false;
    if(!v.mother_name || !hasNoDigits(v.mother_name)) return m.textContent='Mother name invalid (no numbers).', m.classList.add('err'), false;
    if(!v.dob) return m.textContent='Date of Birth is required.', m.classList.add('err'), false;
    if(!v.admission_date) return m.textContent='Date of Admission is required.', m.classList.add('err'), false;
    if(!v.gender) return m.textContent='Gender is required.', m.classList.add('err'), false;
    if(!isAadhaar(v.aadhar_no)) return m.textContent='Aadhaar must be exactly 12 digits.', m.classList.add('err'), false;
    if(!v.admitted_class_id) return m.textContent='Class is required.', m.classList.add('err'), false;
    if(!v.religion) return m.textContent='Religion is required.', m.classList.add('err'), false;
    if(!v.social_category) return m.textContent='Social category is required.', m.classList.add('err'), false;
    if(!isTen(v.whatsapp_no)) return m.textContent='WhatsApp number must be 10 digits.', m.classList.add('err'), false;
    if(!isTen(v.father_contact_no)) return m.textContent='Father contact must be 10 digits.', m.classList.add('err'), false;
    if(v.transport_availed){
      if(!v.pickup_bus_no) return m.textContent='Pickup Bus No. required when Transport = YES.', m.classList.add('err'), false;
      if(!v.pickup_stoppage) return m.textContent='Pickup Stoppage required when Transport = YES.', m.classList.add('err'), false;
    }
    return true;
  }

  async function linkGuardian(email){
    if(!email) return null;
    const { data:p } = await sb.from('profiles').select('user_id').eq('email', email).maybeSingle();
    return p?.user_id || null;
  }

  let editingId = null;

  async function listStudents(){
    const q = el('st_search').value.trim();
    let req = sb.from('students').select('id, admission_no, class_section, student_name, father_name, father_contact_no, whatsapp_no, aadhar_no, admitted_class_id').order('student_name');
    if(q) req = req.or(`student_name.ilike.%${q}%,aadhar_no.ilike.%${q}%,father_contact_no.ilike.%${q}%,whatsapp_no.ilike.%${q}%,admission_no.ilike.%${q}%`);
    const { data: rows } = await req;
    const tb = el('st_rows'); tb.innerHTML='';
    (rows||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.admission_no||''}</td>
        <td>${r.student_name||''}</td>
        <td>${r.admitted_class_id||''} (${r.class_section||''})</td>
        <td>${r.father_name||''}</td>
        <td>${r.father_contact_no||''}${r.whatsapp_no?(' / '+r.whatsapp_no):''}</td>
        <td>${r.aadhar_no||''}</td>
        <td>
          <button class="btn-outline editBtn" data-id="${r.id}">Edit</button>
          <button class="btn-outline delBtn" data-id="${r.id}">Request Delete</button>
        </td>`;
      tb.appendChild(tr);
    });
    document.querySelectorAll('.editBtn').forEach(b=>b.onclick=()=>loadForEdit(b.dataset.id));
    document.querySelectorAll('.delBtn').forEach(b=>b.onclick=()=>requestDelete(b.dataset.id));
  }

  async function loadForEdit(id){
    const { data:r } = await sb.from('students').select('*').eq('id', id).single();
    editingId = id;
    el('st_admission_no').value = r.admission_no||'';
    el('st_class_section').value = r.class_section||'';
    el('st_full_name').value = r.student_name||'';
    el('st_session').value = r.session||'';
    el('st_father_name').value = r.father_name||'';
    el('st_mother_name').value = r.mother_name||'';
    el('st_dob').value = r.dob||'';
    el('st_admission_date').value = r.admission_date||'';
    el('st_gender').value = r.gender||'';
    el('st_aadhar').value = r.aadhar_no||'';
    el('st_class').value = r.admitted_class_id||'';
    el('st_religion').value = r.religion||'';
    el('st_social').value = r.social_category||'';
    el('st_whatsapp').value = r.whatsapp_no||'';
    el('st_father_phone').value = r.father_contact_no||'';
    el('st_address').value = r.address||'';
    // Transport
    el('st_transport_select').value = r.transport_availed ? 'true' : 'false';
    syncTransportUI();
    el('st_pickup_bus').value = r.pickup_bus_no||'';
    el('st_drop_bus').value = r.drop_bus_no||'';
    el('st_pickup_stop').value = r.pickup_stoppage||'';
    el('st_drop_stop').value = r.drop_stoppage||'';
    // Siblings
    el('st_sibling_select').value = r.has_sibling ? 'true' : 'false';
    syncSiblingUI();
    el('st_siblings').value = (r.sibling_names||[]).join('; ');
    // Others
    el('st_mother_phone').value = r.mother_contact_no||'';
    el('st_neigh_phone').value = r.neighbour_contact_no||'';
    el('st_neigh_rel').value = r.neighbour_relation||'';
    el('st_bgroup').value = r.blood_group||'';
    el('st_guardian_email').value = r.guardian_email||'';
  }

  async function saveStudent(){
    const v = readForm();
    if(!validate(v)) return;
    // link guardian if provided
    v.guardian_user_id = await linkGuardian(v.guardian_email);

    let res;
    if(editingId){
      res = await sb.from('students').update(v).eq('id', editingId).select('id').single();
    } else {
      res = await sb.from('students').insert(v).select('id').single();
    }
    el('st_msg').textContent = res.error ? ('Error: '+res.error.message) : (editingId?'Updated.':'Added successfully');
    el('st_msg').className = res.error ? 'muted err' : 'muted ok';
    if (!res.error){ clearForm(); listStudents(); }
  }

  function clearForm(){
    editingId = null;
    ['st_admission_no','st_class_section','st_full_name','st_session','st_father_name','st_mother_name','st_dob','st_admission_date','st_gender','st_aadhar','st_religion','st_social','st_whatsapp','st_father_phone','st_address','st_pickup_bus','st_drop_bus','st_pickup_stop','st_drop_stop','st_mother_phone','st_neigh_phone','st_neigh_rel','st_bgroup','st_siblings','st_guardian_email'].forEach(id=>{ const e=el(id); if(e) e.value=''; });
    el('st_class').value='';
    el('st_transport_select').value='false'; syncTransportUI();
    el('st_same_bus').checked=false; el('st_same_stop').checked=false;
    el('st_sibling_select').value='false'; syncSiblingUI();
    el('st_msg').textContent='';
  }

  async function requestDelete(id){
    const reason = prompt('Reason for delete?');
    if (reason===null) return;
    const { data:{user} } = await sb.auth.getUser();
    const payload = { table_name:'students', row_id:id, reason, requested_by:user.id, status:'pending' };
    const { error } = await sb.from('delete_requests').insert(payload);
    alert(error ? ('Error: '+error.message) : 'Delete request sent to Admin.');
  }

  // events
  document.getElementById('st_save').onclick = saveStudent;
  document.getElementById('st_clear').onclick = clearForm;
  document.getElementById('st_search').oninput = listStudents;
  document.getElementById('st_transport_select').addEventListener('change', syncTransportUI);
  document.getElementById('st_same_bus').addEventListener('change', syncSameBus);
  document.getElementById('st_same_stop').addEventListener('change', syncSameStop);
  document.getElementById('st_sibling_select').addEventListener('change', syncSiblingUI);

  (async()=>{ await ensureRole('accounts'); syncTransportUI(); syncSiblingUI(); await listStudents(); })();
</script>
</body>
</html>
