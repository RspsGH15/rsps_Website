<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RSPS • Admin Dashboard</title>
  <!-- RSPS BUILD v6 -->
  <style>
    :root{ --brand:#0b6ef3; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --bg:#f8fafc; --card:#fff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    main.container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:14px}
    h2{margin:0 0 10px} h3{margin:0 0 8px}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-outline{background:#fff;color:var(--brand);border:1px solid var(--brand);border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{border-top:1px solid var(--line);padding:8px;text-align:left;font-size:14px;vertical-align:top}
    .muted{color:var(--muted);font-size:13px}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const sb = supabase.createClient(
      "https://eqbbddsjutlupckqzlpq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxYmJkZHNqdXRsdXBja3F6bHBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDkzOTMsImV4cCI6MjA3MDIyNTM5M30.CVmsiBCCp98ZQQOEe-1QgrvcJGeRP4DGHUx6j0wPCRI"
    );
    async function ensureRole(role){
      const { data:{user} } = await sb.auth.getUser();
      if(!user){ location.href='index.html#login'; return; }
      const { data:p } = await sb.from('profiles').select('role,full_name,email').eq('user_id',user.id).single();
      if(!p || p.role!==role){ alert('Access denied for '+role); location.href='index.html#login'; return; }
      const who = document.getElementById('who'); if(who) who.textContent=(p.full_name?p.full_name+' ('+p.role+')':(p.email+' ('+p.role+')'));
    }
    const el=(id)=>document.getElementById(id);
  </script>
</head>
<body>
<header>Admin Dashboard <span class="muted" id="who"></span> <a class="btn-outline" href="index.html#login">Logout</a></header>

<main class="container">

  <div class="card">
    <h3>Students — Full Access</h3>
    <div class="row"><button class="btn" id="ad_refresh">Refresh</button><span id="ad_msg" class="muted"></span></div>
    <table>
      <thead><tr><th>Adm No.</th><th>Name</th><th>Class</th><th>Father</th><th>Phones</th><th>Aadhaar</th><th>Actions</th></tr></thead>
      <tbody id="ad_rows"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>Delete Requests (Students)</h3>
    <table><thead><tr><th>When</th><th>Requested By</th><th>Reason</th><th>Actions</th></tr></thead><tbody id="delRows"></tbody></table>
  </div>

  <div class="card">
    <h3>Academic Calendar / Holidays (Apr 2026 – Mar 2027)</h3>
    <div class="row"><button class="btn-outline" id="seed_holidays">Seed Dummy Gazetted Holidays</button><span class="muted" id="hol_msg"></span></div>
    <table><thead><tr><th>Date</th><th>Title</th></tr></thead><tbody id="hol_rows"></tbody></table>
  </div>

</main>

<script>
async function loadStudents(){
  const { data: rows } = await sb.from('students').select('id, admission_no, class_section, student_name, father_name, father_contact_no, whatsapp_no, aadhar_no, admitted_class_id').order('student_name');
  const tb = el('ad_rows'); tb.innerHTML='';
  (rows||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${r.admission_no||''}</td>
      <td>${r.student_name||''}</td>
      <td>${r.admitted_class_id||''} (${r.class_section||''})</td>
      <td>${r.father_name||''}</td>
      <td>${r.father_contact_no||''}${r.whatsapp_no?(' / '+r.whatsapp_no):''}</td>
      <td>${r.aadhar_no||''}</td>
      <td>
        <button class="btn-outline" onclick="editStud('${r.id}')">Edit</button>
        <button class="btn-outline" onclick="delStud('${r.id}')">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function editStud(id){ alert('Admin edit: use Accounts page for full form editing in this build.'); }
async function delStud(id){
  if(!confirm('Delete student permanently?')) return;
  const { error } = await sb.from('students').delete().eq('id', id);
  el('ad_msg').textContent = error ? ('Error: '+error.message) : 'Deleted.';
  loadStudents();
}

async function loadDeleteRequests(){
  const { data: reqs } = await sb.from('delete_requests')
    .select('id, table_name, row_id, reason, requested_by, status, created_at')
    .eq('table_name','students').eq('status','pending').order('created_at',{ascending:false});
  const { data: profs } = await sb.from('profiles').select('user_id, full_name, email');
  const map = Object.fromEntries((profs||[]).map(p=>[p.user_id,(p.full_name||p.email||p.user_id)]));
  const tb = el('delRows'); tb.innerHTML='';
  (reqs||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(r.created_at).toLocaleString()}</td>
      <td>${map[r.requested_by]||r.requested_by}</td>
      <td>${r.reason||''}</td>
      <td>
        <button class="btn" onclick="approveDel('${r.id}','${r.row_id}')">Approve & Delete</button>
        <button class="btn-outline" onclick="rejectDel('${r.id}')">Reject</button>
      </td>`;
    tb.appendChild(tr);
  });
}
async function approveDel(reqId,rowId){
  const del = await sb.from('students').delete().eq('id', rowId);
  if (del.error) return alert('Delete failed: '+del.error.message);
  const { data:{user} } = await sb.auth.getUser();
  await sb.from('delete_requests').update({ status:'approved', processed_by:user.id, processed_at:new Date().toISOString() }).eq('id', reqId);
  loadDeleteRequests(); loadStudents();
}
async function rejectDel(reqId){
  const { data:{user} } = await sb.auth.getUser();
  await sb.from('delete_requests').update({ status:'rejected', processed_by:user.id, processed_at:new Date().toISOString() }).eq('id', reqId);
  loadDeleteRequests();
}

async function seedHolidays(){
  const items = [
    ['2026-04-14','Dr. Ambedkar Jayanti'],
    ['2026-04-19','Mahavir Jayanti'],
    ['2026-05-01','Labour Day'],
    ['2026-08-15','Independence Day'],
    ['2026-10-02','Gandhi Jayanti'],
    ['2026-10-19','Diwali (approx)'],
    ['2026-12-25','Christmas'],
    ['2027-01-26','Republic Day'],
    ['2027-03-08','Holi (approx)']
  ];
  for (const [d,t] of items) { await sb.from('holidays').insert({ day:d, title:t }); }
  document.getElementById('hol_msg').textContent='Seeded dummy list.'; loadHolidays();
}
async function loadHolidays(){
  const { data: rows } = await sb.from('holidays').select('day, title').order('day');
  const tb = el('hol_rows'); tb.innerHTML='';
  (rows||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.day}</td><td>${r.title}</td>`;
    tb.appendChild(tr);
  });
}

document.getElementById('ad_refresh').onclick=loadStudents;
document.getElementById('seed_holidays').onclick=seedHolidays;

(async()=>{ await ensureRole('admin'); await loadStudents(); await loadDeleteRequests(); await loadHolidays(); })();
</script>
</body>
</html>
